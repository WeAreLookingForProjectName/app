<% content_for(:sidebar) do %>
  <div class="sidebar row bg-white border rounded mb-3 pb-3">
    <div class="col-12 rounded-top bg-dark text-white pt-2 pb-2">
      <%= t('sub') %>

      <span class="dropdown-toggle float-right" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <%= fa_icon(:cog) %>
      </span>

      <div class="dropdown-menu dropdown-menu-right">
        <% if ModQueuePolicy.new(pundit_user, nil).index? %>
          <%= link_to(t("mod_queue"), mod_queues_path(sub: @sub), class: "dropdown-item") %>
        <% end %>

        <% if policy(Moderator).index? %>
          <%= link_to(t("moderators"), moderators_path(sub: @sub), class: "dropdown-item") %>
        <% end %>

        <% if policy(Ban).index? %>
          <%= link_to(t("bans"), bans_path(sub: @sub), class: "dropdown-item") %>
        <% end %>

        <% if policy(Contributor).index? %>
          <%= link_to(t("contributors"), contributors_path(sub: @sub), class: "dropdown-item") %>
        <% end %>

        <% if policy(Rule).index? %>
          <%= link_to(t("rules"), rules_path(sub: @sub), class: "dropdown-item") %>
        <% end %>

        <% if policy(DeletionReason).index? %>
          <%= link_to(t("deletion_reasons"), deletion_reasons_path(sub: @sub), class: "dropdown-item") %>
        <% end %>

        <% if policy(Tag).index? %>
          <%= link_to(t("tags"), tags_path(sub: @sub), class: "dropdown-item") %>
        <% end %>

        <% if policy(Page).index? %>
          <%= link_to(t("pages"), pages_path(sub: @sub), class: "dropdown-item") %>
        <% end %>

        <% if policy(BlacklistedDomain).index? %>
          <%= link_to(t("blacklisted_domains"), blacklisted_domains_path(sub: @sub), class: "dropdown-item") %>
        <% end %>

        <% if policy(@sub).update? %>
          <%= link_to(t("settings"), edit_sub_path(@sub), class: "dropdown-item") %>
        <% end %>
      </div>
    </div>

    <div class="col-12 mt-2">
      <%= link_to(@sub.title, sub_path(@sub), class: 'font-weight-bold') %>
    </div>

    <div class="col-12 mt-2">
      <%= number_with_delimiter(@sub.follows_count) %> <%= t('follows_count', count: @sub.follows_count) %>
    </div>

    <div class="col-12 mt-2">
      <%= @sub.description %>
    </div>

    <div class="col-12 mt-2">
      <% if current_user&.follower?(@sub) %>
        <%= link_to(t('unsubscribe'), sub_follows_path(@sub), class: 'follow btn btn-primary btn-block', remote: true, method: :delete) %>
      <% else %>
        <%= link_to(t('subscribe'), sub_follows_path(@sub), class: 'follow btn btn-primary btn-block', remote: true, method: :post) %>
      <% end %>

      <% if user_signed_in? %>
        <%= link_to(t('create_post'), new_post_path(sub: @sub), class: 'btn btn-primary btn-block') %>
      <% else %>
        <%= link_to(t('create_post'), new_sign_in_path, remote: true, class: 'signIn btn btn-primary btn-block') %>
      <% end %>
    </div>
  </div>

  <% if user_signed_in? %>
    <% ban = current_user.bans.find { |ban| ban.sub_id == @sub.id } %>
    <% if ban.present? %>
      <div class="row bg-white text-danger border rounded mt-3 mb-3 pt-2 pb-2">
        <div class="col-12">
          <% if ban.permanent? %>
            <%= t('banned_permanent') %>
          <% else %>
            <%= t('banned_until_html', until: datetime_tag(ban.end_at, :short)) %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <% if @sub.rules.present? %>
    <div class="row bg-white border rounded mt-3 mb-3 pb-2">
      <div class="col-12 rounded-top bg-dark text-white pt-2 pb-2">
        <%= t('rules') %>
      </div>

      <div class="col-12 mt-2">
        <div class="row">
          <% @sub.rules.each do |rule| %>
            <% if rule.description.present? %>
              <div class="sidebarRule col-12 mt-1" data-toggle="collapse" data-target="#sidebarRule<%= rule.to_param %>" aria-expanded="false">
                <%= rule.title %> <%= fa_icon('caret-down', class: 'float-right') %>
              </div>

              <div class="col-12 collapse mt-1" id="sidebarRule<%= rule.to_param %>">
                <%= rule.description %>
              </div>
            <% else %>
              <div class="col-12 mt-1">
                <%= rule.title %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <% moderators = @sub.moderators.includes(:user).order(id: :asc).limit(10).all %>
  <% if moderators.present? %>
    <div class="row bg-white border rounded mt-3 mb-3 pb-2">
      <div class="col-12 rounded-top bg-dark text-white pt-2 pb-2">
        <%= t('moderators') %>
      </div>

      <div class="col-12 mt-2">
        <div class="row">
          <% moderators.each do |moderator| %>
            <div class="col-12">
              <%= link_to(moderator.user.username, user_path(moderator.user)) %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
<% end %>