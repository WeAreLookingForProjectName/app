<% content_for(:meta_title, @post.title) %>

<%= render 'shared/sidebar', community: @post.community %>

<div class="col-12 bg-white border rounded pb-3 mb-3">
  <div class="post row mt-2">
    <div class="info col-12">
      <%= link_to(@post.user.username, posts_user_path(@post.user)) %> <%= @post.created_at %>

      <% if @post.edited? %>
        <%= @post.edited_at %>
      <% end %>

      <% if @post.explicit? %>
        <span class="explicit"><%= t('explicit') %></span>
      <% end %>

      <% if @post.spoiler? %>
        <span class="spoiler"><%= t('spoiler') %></span>
      <% end %>
    </div>

    <div class="title col-12 mt-1">
      <%= link_to(@post.title, post_path(@post)) %>
    </div>

    <% if @post.content_processing? %>
      <div class="content col-12 mt-2">
        <%= @post.content_processing_message %>
      </div>
    <% elsif @post.removed? %>
      <div class="content col-12 mt-2">
        <%= @post.removed_message %>
      </div>
    <% else %>
      <%= render @post.content_partial, post: @post %>
    <% end %>

    <div class="actions col-12">
      <span class="vote">
        <%= @post.up_vote_link %>
        <%= @post.score %>
        <%= @post.down_vote_link %>
      </span>

      <%= @post.comments_link %>
      <%= @post.bookmark_link %>

      <% if policy(@post).approve? %>
        <%= @post.approve_link %>
      <% end %>

      <% if policy(@post).destroy? %>
        <%= @post.remove_link %>
      <% end %>

      <span class="menu dropdown">
        <span class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <%= fa_icon("ellipsis-h") %>
        </span>

        <div class="dropdown-menu">
          <% if policy(Report).create? %>
            <%= @post.report_link %>
          <% end %>

          <% if policy(Report).index? %>
            <%= @post.reports_link %>
          <% end %>

          <% if policy(@post).update_text? %>
            <%= @post.edit_link %>
          <% end %>

          <% if policy(@post).update_explicit? %>
            <%= @post.explicit_link %>
          <% end %>

          <% if policy(@post).update_spoiler? %>
            <%= @post.spoiler_link %>
          <% end %>

          <% if policy(@post).update_ignore_reports? %>
            <%= @post.ignore_reports_link %>
          <% end %>
        </div>
      </span>
    </div>
  </div>

  <% if policy(Comment).create? %>
    <div class="row mt-3">
      <div class="col-12">
        <%= form_with(model: CreateComment.new, url: post_comments_path(@post), class: 'createCommentForm') do |f| %>
          <%= f.text_area :text, label: false %>
          <%= f.submit t('reply'), class: 'btn-sm' %>

          <span class="formatting float-right mt-2" data-toggle="collapse" data-target="#formatting" aria-expanded="false">
            <%= t('formatting') %>
          </span>

          <div class="collapse mt-2" id="formatting">
            <%= t('formatting_body_html') %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if user_signed_out? %>
    <div class="row mt-3">
      <div class="col-12">
        <div class="row">
          <div class="col-6 mt-2">
            <%= t('login_or_sign_up') %>
          </div>

          <div class="col-6 text-right">
            <%= link_to(t('sign_in'), new_sign_in_path, remote: true, class: 'signIn btn btn-primary') %>
            <%= link_to(t('sign_up'), new_sign_up_path, remote: true, class: 'signUp btn btn-primary') %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="row mt-3">
    <div class="col-12">
      <span id="sort" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <%= @sort_options.fetch(@sort, @sort_options['best']) %>
      </span>

      <div class="dropdown-menu">
        <% @sort_options.each do |k, v| %>
          <%= link_to(v, post_path(@post, sort: k, anchor: 'sort'), class: 'dropdown-item') %>
        <% end %>
      </div>
    </div>
  </div>

  <!--  <#%= render partial: "comments/nested", locals: { item: @topic.branch } %>-->
</div>
